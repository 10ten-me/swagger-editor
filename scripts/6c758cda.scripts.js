"use strict";function getJsonString(a){var b=jsyaml.load(a.getSession().getValue());return JSON.stringify(b,null,4)}function loadPreDefinedSpecs(a){return $.get("spec-files/"+a+".yaml")}function setOperationsCollapsed(a,b){a.listed=b,a.resource.apis.forEach(function(a){a.operations.forEach(function(a){a.collapsed=b})})}function getResourceAndDescription(a){return{resourcePath:a.resourcePath,description:a.description}}function buildDocs(a,b){var c;a.invalidDocs=!1;try{c=load(b)}catch(d){return void(a.invalidDocs=!0)}c&&Array.isArray(c.apiDeclarations)&&(a.apiDeclarations=c.apiDeclarations,a.$digest())}window.PhonicsApp=angular.module("PhonicsApp",["ngCookies","ngResource","ngSanitize","ui.router","ui.ace","ngStorage"]),PhonicsApp.config(["$compileProvider","$stateProvider","$urlRouterProvider",function(a,b,c){c.otherwise("/"),b.state("home",{url:"/",views:{"":{templateUrl:"views/main.html",controller:"MainCtrl"},"header@home":{templateUrl:"views/header/header.html",controller:"HeaderCtrl"},"editor@home":{templateUrl:"views/editor/editor.html"},"preview@home":{templateUrl:"views/preview/preview.html"}}}).state("home.apiDeclarition",{url:":apiDeclaritionId",views:{"preview@home":{controller:"ApiDeclarationCtrl",templateUrl:"views/preview/preview.html"}}}),a.aHrefSanitizationWhitelist(".")}]),_.templateSettings={interpolate:/\{(.+?)\}/g},PhonicsApp.controller("MainCtrl",["$scope","$rootScope","$localStorage","wrap","editorHelper","downloadHelper","builderHelper",function(a,b,c,d,e,f,g){function h(b){$(document).on("pane-resize",b.resize.bind(b)),c.cache?(b.getSession().setValue(c.cache),g.buildDocs(a,c.cache)):a.resetSpec()}function i(a){_.debounce(function(){window.requestAnimationFrame(function(){c.cache=a})},500)}var j=null,k=null;a.previewMode="html",a.editorErrorMessage="",a.invalidDocs=!1,a.emptyDocs=!1,b.$on("$stateChangeStart",function(){h(j)}),a.aceLoaded=function(a){j=a,h(j)},a.jsonPreviewLoaded=function(a){k=a},a.setEditorValue=function(a){j.getSession().setValue(a)},a.aceChanged=function(){a.invalidDocs=!1,a.emptyDocs=!1;var b=null,c=j.getSession().getValue();return i(c),c?(b=e.annotateYAMLErrors(j))?void(a.invalidDocs=!0):(a.editorErrorMessage="",void g.buildDocs(a,j.getSession().getValue())):void(a.emptyDocs=!0)},a.switchPreviewMode=function(b){a.previewMode=b,"json"===b&&a.jsonPreview.getSession().setValue(getJsonString(j))},a.jsonLoaded=function(){},a.newProject=function(){j.getSession().setValue(""),a.apiDeclarations=[],g.buildDocs(a,"")},a.resetSpec=function(){loadPreDefinedSpecs("default_full").then(function(b){c.cache=b,j.getSession().setValue(b),g.buildDocs(a,j.getSession().getValue())})},a.assignDownloadHrefs=function(){f.assignDownloadHrefs(a,j,k)},a.generateZip=function(a,b){var c="http://generator.wordnik.com/online/api/gen/"+a+"/"+b,e=jsyaml.load(j.getSession().getValue());e=d.model(e),e=d.opts(e),f.getZipFile(c,e)}}]),PhonicsApp.controller("HeaderCtrl",["$scope",function(a){a.name="Swagger Editor"}]),PhonicsApp.controller("ApiDeclarationCtrl",["$scope","$stateParams","$state","getResourceNameFilter","editorHelper",function(a,b,c,d){var e=b.apiDeclaritionId;Array.isArray(a.$parent.apiDeclarations)?a.$parent.apiDeclarations.forEach(function(b){d(b)===e&&(a.$parent.setEditorValue(jsyaml.dump(b)),a.apiDeclarations=[b])}):c.go("home")}]),PhonicsApp.directive("splitterBar",function(){return{template:"",replace:!1,restrict:"E",link:function(a,b,c){function d(a){var d=a.pageX-f.offset().left,g=a.pageY-f.offset().top,h=100;if("horizontal"in c){if(h>g||g>f.height()-h)return;e.trigger("pane-resize"),b.css("top",g),$("#"+c.topPane).css("height",g+b.height()),$("#"+c.bottomPane).css("height",f.height()-g)}else{if(h>d||d>f.width()-h)return;e.trigger("pane-resize"),b.css("left",d),$("#"+c.leftPane).css("width",d),$("#"+c.rightPane).css("width",f.width()-d-b.width())}}var e=$(document),f=b.parent();b.on("mousedown",function(a){a.preventDefault(),e.on("mousemove",d),e.on("mouseup",function(){e.off("mousemove",d)})}),$(window).on("resize",_.throttle(d,300))}}}),PhonicsApp.directive("resource",function(){return{restrict:"E",replace:!0,templateUrl:"templates/resource.html",scope:{resource:"="},link:function(a){a.collapsed=!1,a.collapseAll=function(){a.collapsed=!1,setOperationsCollapsed(a,!0)},a.expandAll=function(){a.collapsed=!1,setOperationsCollapsed(a,!1)}}}}),PhonicsApp.directive("operation",["$timeout",function(a){function b(b){var c=!0;return b.parameters.forEach(function(b){b.required&&!b.inputValue&&(c=!1,b.shake=!0,a(function(){b.shake=!1},900))}),c}function c(a,b,c){var d=a,e={},f={};return c.forEach(function(a){"path"===a.paramType&&(e[a.name]=a.inputValue),"query"===a.paramType&&(f[a.name]=a.inputValue)}),d+=_.template(b)(e),d+="?"+$.param(f)}function d(a,d){if(b(a)){var e=a.parameters.map(function(a){var b=Object.create(null);return b[a.name]=a.inputValue,b});$.ajax({url:c(d,a.path,a.parameters),method:a.method,data:e}).then(function(a){console.log(a)})}}return{restrict:"E",replace:!0,templateUrl:"templates/operation.html",link:function(a){a.tryIt=d}}}]),PhonicsApp.directive("signature",function(){function a(){return"{todo: true}"}function b(){return!0}function c(c){c.getSampleJSON=a,c.visibilePane=0,c.sampleJSON=a(c.type,c.models),c.isPrimitive=b(c.type,c.models)}return{scope:{models:"=",type:"="},link:c,restrict:"E",replace:!0,templateUrl:"templates/signature.html"}}),PhonicsApp.directive("dropdownMenu",function(){return{templateUrl:"templates/dropdown-menu.html",restrict:"E",transclude:!0,scope:{label:"@",onOpen:"="}}}),PhonicsApp.filter("markdown",function(){return function(a){var b=null;return b=a.indexOf("\n")>-1?markdown.toHTML(a):a}}),PhonicsApp.filter("getResourceName",function(){return function(a){return a.resourcePath.replace(/\//g,"")}}),PhonicsApp.value("wrap",{model:function(a){return{model:{apiDeclarations:a.apiDeclarations,apiVersion:a.apiVersion,swaggerVersion:a.swaggerVersion,authorizations:a.authorizations,apis:a.apiDeclarations.map(getResourceAndDescription)}}},opts:function(a){return _.extend(a,{opts:{properties:{modelPackage:"com.reverb.models",apiPackage:"com.reverb.apis",groupId:"com.reverb.swagger",artifactId:"swagger-client",artifactVersion:"1.0.0"}}})}}),PhonicsApp.value("editorHelper",{annotateYAMLErrors:function(a){var b=null,c=a.getSession().getValue();try{jsyaml.load(c)}catch(d){return b=d.message.replace("JS-YAML: ",""),a.getSession().setAnnotations([{row:d.mark.line,column:d.mark.column,text:b,type:"error"}]),b}return a.getSession().clearAnnotations(),b}}),PhonicsApp.value("downloadHelper",{getZipFile:function(a,b){$.ajax({type:"POST",contentType:"application/json",url:a,data:JSON.stringify(b),processData:!1}).then(function(a){a instanceof Object&&a.code&&(window.location="http://generator.wordnik.com/online/api/gen/download/"+a.code)})},assignDownloadHrefs:function(a,b){var c="text/plain",d=jsyaml.load(b.getSession().getValue()),e=JSON.stringify(d,null,2),f=new Blob([e],{type:c});a.jsonDownloadHref=window.URL.createObjectURL(f),a.jsonDownloadUrl=[c,"spec.json",a.jsonDownloadHref].join(":");var g=new Blob([b.getSession().getValue()],{type:c});a.yamlDownloadHref=window.URL.createObjectURL(g),a.yamlDownloadUrl=[c,"spec.yaml",a.yamlDownloadHref].join(":")}});var load=_.memoize(jsyaml.load);PhonicsApp.value("builderHelper",{buildDocs:_.debounce(buildDocs,300)});